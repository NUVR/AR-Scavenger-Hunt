version: 2

jobs:
  build:
    docker:
      - image: circleci/node:8.15.0
    steps:
      - checkout
      - restore_cache:
          keys:
            - yarn-v1-{{ checksum "yarn.lock" }}
            - yarn-v1-
      - run:
          name: Install Git LFS and pull files
          command: |
            if ! [ -x "$(command -v git-lfs)" ]; then
                curl -L -o /tmp/git-lfs.tar.gz \
                  https://github.com/git-lfs/git-lfs/releases/download/v2.7.1/git-lfs-linux-amd64-v2.7.1.tar.gz
                tar xf /tmp/git-lfs.tar.gz -C /tmp
                sudo /tmp/git-lfs-2.4.0/install.sh
            fi
            git lfs pull
      - run:
          name: Install NPM modules
          command: |
            yarn cache dir
            yarn install --frozen-lockfile
            yarn add firebase-tools
            yarn run firebase --version
      - save_cache:
          key: yarn-v1-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn/v1
      - run:
          name: Build
          command: |
            yarn build
      - run:
          name: Deploy
          command: |
            yarn deploy
